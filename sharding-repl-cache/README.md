# pymongo-api

*Примечание. Все указанные ниже команды делаются из директории sharding-repl-cache.*

Приложение базируется на распределенной базе данных MongoDB. В качестве базы данных используется MongoDB. База данных оптимизирована под шардирование с репликацией для повышения надежности. Приложение так же поддерживает кэширование.

Приложение состоит из следующих компонентов (контейнеров):

- `mongo_config_srv` - Сервер конфигурации MongoDB. На сервере хранится метаинформация кластера MongoDB;
- `mongo_shard1` - MongoDB, шард 1;
- `mongo_shard1_r1` - MongoDB, реплика 1 шарда 1;
- `mongo_shard1_r2` - MongoDB, реплика 2 шарда 1;
- `mongo_shard1_r3` - MongoDB, реплика 3 шарда 1;
- `mongo_shard2` - MongoDB, шард 2;
- `mongo_shard2_r1` - MongoDB, реплика 1 шарда 2;
- `mongo_shard2_r2` - MongoDB, реплика 2 шарда 2;
- `mongo_shard2_r3` - MongoDB, реплика 3 шарда 2;
- `mongo_router` - Маршрутизатор запросов к конкретным шардам;
- `redis_1` - Redis, кэш приложения;
- `pymongo_api` - Основное приложение, которое реализовывает бизнес-логику.

## Как запустить

Запустить кластер MongoDB и основное приложение можно следующей командой:

```shell
docker compose up -d
```

### Настройка компонентов

Приложение состоит из множества компонентов, каждый из которых запускается независимо. Поэтому настройку компонентов удобнее производить независимо по готовности каждого компонента.

Ниже описана настройка конкретных компонентов.

#### Сервер конфигурации

Для настройки необходимо выполнить скрипт:

```shell
./scripts/init_config.sh
```

#### Шард 1

Для настройки шарда 1 и его реплик необходимо выполнить скрипт:

```shell
./scripts/init_shard1.sh
```
Настройку необходимо проводить после запуска всех компонентов шарда 1, включая реплики.

#### Шард 2

Для настройки шарда 2 и его реплик необходимо выполнить скрипт:

```shell
./scripts/init_shard2.sh
```

Настройку необходимо проводить после запуска всех компонентов шарда 2, включая реплики.

#### Маршрутизатор запросов БД

Для настройки необходимо выполнить скрипт:

```shell
./scripts/init_routing.sh
```

#### Наполнение тестовыми данными

При необходимости наполнить БД тестовыми данными, нужно вызвать:

```shell
./scripts/fill_test_data.sh
```

## Как проверить

### Если вы запускаете проект на локальной машине

Откройте в браузере http://localhost:8080

### Если вы запускаете проект на предоставленной виртуальной машине

Узнать белый ip виртуальной машины

```shell
curl --silent http://ifconfig.me
```

Откройте в браузере http://<ip виртуальной машины>:8080

## Доступные эндпоинты

Список доступных эндпоинтов, swagger http://<ip физической или виртуальной машины>:8080/docs
